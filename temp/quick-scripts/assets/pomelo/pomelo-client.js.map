{"version":3,"sources":["pomelo-client.js"],"names":["JS_WS_CLIENT_TYPE","JS_WS_CLIENT_VERSION","Protocol","require","Package","Message","EventEmitter","window","sys","localStorage","RES_OK","RES_FAIL","RES_OLD_CLIENT","Object","create","o","F","prototype","root","pomelo","socket","reqId","callbacks","handlers","routeMap","heartbeatInterval","heartbeatTimeout","nextHeartbeatTimeout","gapThreshold","heartbeatId","heartbeatTimeoutId","handshakeCallback","decode","encode","useCrypto","handshakeBuffer","type","version","initCallback","init","params","cb","host","port","url","user","initWebSocket","onopen","event","obj","TYPE_HANDSHAKE","strencode","JSON","stringify","send","onmessage","processPackage","data","Date","now","onerror","emit","cc","error","onclose","WebSocket","binaryType","disconnect","close","log","clearTimeout","request","route","msg","arguments","length","sendMessage","notify","TYPE_REQUEST","TYPE_NOTIFY","protos","client","protobuf","compressRoute","dict","packet","TYPE_DATA","buffer","handler","heartbeat","TYPE_HEARTBEAT","setTimeout","heartbeatTimeoutCb","gap","handshake","parse","strdecode","code","handshakeInit","TYPE_HANDSHAKE_ACK","onData","id","body","deCompose","processMessage","onKick","TYPE_KICK","msgs","Array","isArray","i","processMessageBatch","l","server","abbrs","initData","encoderProtos","decoderProtos","module","exports"],"mappings":"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","file":"pomelo-client.js","sourceRoot":"../../../../assets/pomelo","sourcesContent":["(function() {\n  var JS_WS_CLIENT_TYPE = 'js-websocket';\n  var JS_WS_CLIENT_VERSION = '0.0.1';\n\n  var Protocol = require(\"protocol\");\n  var Package = Protocol.Package;\n  var Message = Protocol.Message;\n  var EventEmitter = window.EventEmitter;\n\n  if(typeof(window) != \"undefined\" && typeof(sys) != 'undefined' && sys.localStorage) {\n    window.localStorage = sys.localStorage;\n  }\n  \n  var RES_OK = 200;\n  var RES_FAIL = 500;\n  var RES_OLD_CLIENT = 501;\n\n  if (typeof Object.create !== 'function') {\n    Object.create = function (o) {\n      function F() {}\n      F.prototype = o;\n      return new F();\n    };\n  }\n\n  var root = window;\n  var pomelo = Object.create(EventEmitter.prototype); // object extend from object\n  root.pomelo = pomelo;\n  var socket = null;\n  var reqId = 0;\n  var callbacks = {};\n  var handlers = {};\n  //Map from request id to route\n  var routeMap = {};\n\n  var heartbeatInterval = 0;\n  var heartbeatTimeout = 0;\n  var nextHeartbeatTimeout = 0;\n  var gapThreshold = 100;   // heartbeat gap threashold\n  var heartbeatId = null;\n  var heartbeatTimeoutId = null;\n\n  var handshakeCallback = null;\n\n  var decode = null;\n  var encode = null;\n\n  var useCrypto;\n\n  var handshakeBuffer = {\n    'sys': {\n      type: JS_WS_CLIENT_TYPE,\n      version: JS_WS_CLIENT_VERSION\n    },\n    'user': {\n    }\n  };\n\n  var initCallback = null;\n\n  pomelo.init = function(params, cb){\n    initCallback = cb;\n    var host = params.host;\n    var port = params.port;\n\n    var url = 'ws://' + host;\n    if(port) {\n      url +=  ':' + port;\n    }\n\n    handshakeBuffer.user = params.user;\n    handshakeCallback = params.handshakeCallback;\n    initWebSocket(url, cb);\n  };\n\n  var initWebSocket = function(url,cb){\n    var onopen = function(event){\n      var obj = Package.encode(Package.TYPE_HANDSHAKE, Protocol.strencode(JSON.stringify(handshakeBuffer)));\n      send(obj);\n    };\n    var onmessage = function(event) {\n      processPackage(Package.decode(event.data), cb);\n      // new package arrived, update the heartbeat timeout\n      if(heartbeatTimeout) {\n        nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\n      }\n    };\n    var onerror = function(event) {\n      pomelo.emit('io-error', event);\n      cc.error('socket error: ', event);\n    };\n    var onclose = function(event){\n      pomelo.emit('close',event);\n      pomelo.emit('disconnect', event);\n      cc.error('socket close: ', event);\n    };\n    socket = new WebSocket(url);\n    socket.binaryType = 'arraybuffer';\n    socket.onopen = onopen;\n    socket.onmessage = onmessage;\n    socket.onerror = onerror;\n    socket.onclose = onclose;\n  };\n\n  pomelo.disconnect = function() {\n    if(socket) {\n      if(socket.disconnect) socket.disconnect();\n      if(socket.close) socket.close();\n      cc.log('disconnect');\n      socket = null;\n    }\n\n    if(heartbeatId) {\n      clearTimeout(heartbeatId);\n      heartbeatId = null;\n    }\n    if(heartbeatTimeoutId) {\n      clearTimeout(heartbeatTimeoutId);\n      heartbeatTimeoutId = null;\n    }\n  };\n\n  pomelo.request = function(route, msg, cb) {\n    if(arguments.length === 2 && typeof msg === 'function') {\n      cb = msg;\n      msg = {};\n    } else {\n      msg = msg || {};\n    }\n    route = route || msg.route;\n    if(!route) {\n      return;\n    }\n\n    reqId++;\n    sendMessage(reqId, route, msg);\n\n    callbacks[reqId] = cb;\n    routeMap[reqId] = route;\n  };\n\n  pomelo.notify = function(route, msg) {\n    msg = msg || {};\n    sendMessage(0, route, msg);\n  };\n\n  var sendMessage = function(reqId, route, msg) {\n    var type = reqId ? Message.TYPE_REQUEST : Message.TYPE_NOTIFY;\n\n    //compress message by protobuf\n    var protos = !!pomelo.data.protos?pomelo.data.protos.client:{};\n    if(!!protos[route]){\n      msg = protobuf.encode(route, msg);\n    }else{\n      msg = Protocol.strencode(JSON.stringify(msg));\n    }\n\n\n    var compressRoute = 0;\n    if(pomelo.dict && pomelo.dict[route]){\n      route = pomelo.dict[route];\n      compressRoute = 1;\n    }\n\n    msg = Message.encode(reqId, type, compressRoute, route, msg);\n    var packet = Package.encode(Package.TYPE_DATA, msg);\n    send(packet);\n  };\n\n  var send = function(packet){\n    socket.send(packet.buffer);\n  };\n\n\n  var handler = {};\n\n  var heartbeat = function(data) {\n    if(!heartbeatInterval) {\n      // no heartbeat\n      return;\n    }\n\n    var obj = Package.encode(Package.TYPE_HEARTBEAT);\n    if(heartbeatTimeoutId) {\n      clearTimeout(heartbeatTimeoutId);\n      heartbeatTimeoutId = null;\n    }\n\n    if(heartbeatId) {\n      // already in a heartbeat interval\n      return;\n    }\n\n    heartbeatId = setTimeout(function() {\n      heartbeatId = null;\n      send(obj);\n\n      nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, heartbeatTimeout);\n    }, heartbeatInterval);\n  };\n\n  var heartbeatTimeoutCb = function() {\n    var gap = nextHeartbeatTimeout - Date.now();\n    if(gap > gapThreshold) {\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, gap);\n    } else {\n      cc.error('server heartbeat timeout');\n      pomelo.emit('heartbeat timeout');\n      pomelo.disconnect();\n    }\n  };\n\n  var handshake = function(data){\n    data = JSON.parse(Protocol.strdecode(data));\n    if(data.code === RES_OLD_CLIENT) {\n      pomelo.emit('error', 'client version not fullfill');\n      return;\n    }\n\n    if(data.code !== RES_OK) {\n      pomelo.emit('error', 'handshake fail');\n      return;\n    }\n\n    handshakeInit(data);\n\n    var obj = Package.encode(Package.TYPE_HANDSHAKE_ACK);\n    send(obj);\n    if(initCallback) {\n      initCallback(socket);\n      initCallback = null;\n    }\n  };\n\n  var onData = function(data){\n    //probuff decode\n    var msg = Message.decode(data);\n\n    if(msg.id > 0){\n      msg.route = routeMap[msg.id];\n      delete routeMap[msg.id];\n      if(!msg.route){\n        return;\n      }\n    }\n\n    msg.body = deCompose(msg);\n\n    processMessage(pomelo, msg);\n  };\n\n  var onKick = function(data) {\n    data = JSON.parse(Protocol.strdecode(data));\n    pomelo.emit('onKick', data);\n  };\n\n  handlers[Package.TYPE_HANDSHAKE] = handshake;\n  handlers[Package.TYPE_HEARTBEAT] = heartbeat;\n  handlers[Package.TYPE_DATA] = onData;\n  handlers[Package.TYPE_KICK] = onKick;\n\n  var processPackage = function(msgs) {\n    if(Array.isArray(msgs)) {\n      for(var i=0; i<msgs.length; i++) {\n        var msg = msgs[i];\n        handlers[msg.type](msg.body);\n      }\n    } else {\n      handlers[msgs.type](msgs.body);\n    }\n  };\n\n  var processMessage = function(pomelo, msg) {\n    if(!msg.id) {\n      // server push message\n      pomelo.emit(msg.route, msg.body);\n    }\n\n    //if have a id then find the callback function with the request\n    var cb = callbacks[msg.id];\n\n    delete callbacks[msg.id];\n    if(typeof cb !== 'function') {\n      return;\n    }\n\n    cb(msg.body);\n    return;\n  };\n\n  var processMessageBatch = function(pomelo, msgs) {\n    for(var i=0, l=msgs.length; i<l; i++) {\n      processMessage(pomelo, msgs[i]);\n    }\n  };\n\n  var deCompose = function(msg){\n    var protos = !!pomelo.data.protos?pomelo.data.protos.server:{};\n    var abbrs = pomelo.data.abbrs;\n    var route = msg.route;\n\n    //Decompose route from dict\n    if(msg.compressRoute) {\n      if(!abbrs[route]){\n        return {};\n      }\n\n      route = msg.route = abbrs[route];\n    }\n    if(!!protos[route]){\n      return protobuf.decode(route, msg.body);\n    }else{\n      return JSON.parse(Protocol.strdecode(msg.body));\n    }\n\n    return msg;\n  };\n\n  var handshakeInit = function(data){\n    if(data.sys && data.sys.heartbeat) {\n      heartbeatInterval = data.sys.heartbeat * 1000;   // heartbeat interval\n      heartbeatTimeout = heartbeatInterval * 2;        // max heartbeat timeout\n    } else {\n      heartbeatInterval = 0;\n      heartbeatTimeout = 0;\n    }\n\n    initData(data);\n\n    if(typeof handshakeCallback === 'function') {\n      handshakeCallback(data.user);\n    }\n  };\n\n  //Initilize data used in pomelo client\n  var initData = function(data){\n    if(!data || !data.sys) {\n      return;\n    }\n    pomelo.data = pomelo.data || {};\n    var dict = data.sys.dict;\n    var protos = data.sys.protos;\n\n    //Init compress dict\n    if(dict){\n      pomelo.data.dict = dict;\n      pomelo.data.abbrs = {};\n\n      for(var route in dict){\n        pomelo.data.abbrs[dict[route]] = route;\n      }\n    }\n\n    //Init protobuf protos\n    if(protos){\n      pomelo.data.protos = {\n        server : protos.server || {},\n        client : protos.client || {}\n      };\n      if(!!protobuf){\n        protobuf.init({encoderProtos: protos.client, decoderProtos: protos.server});\n      }\n    }\n  };\n\n  module.exports = pomelo;\n})();\n"]}